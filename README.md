### Compile

```
arduino-cli compile -v --fqbn arduino:avr:uno && arduino-cli upload -v -p /dev/$(ls /dev | grep cu.usb) --fqbn arduino:avr:uno && screen /dev/$(ls /dev | grep tty.usb) 115200
```

### Patches/Modulation

Patch parameters are 8 bit 0..255.
Internal modulation attributes can/could be calculated via 8+8 bit integer/fraction math and scaled to the relevant DAC intervals.

### Doodle

12 bit DAC

-0.75V / Octave => -0.75 V / 12 semitones = -0.0625 V per semitone

0V = F0 = 500Hz

With DAC Vref = 5V

1 bit = 5V / 4096 = 0.001220703125 V

(Voltage unit per octave / number of semitones) / ( DAC Voltage reference / DAC bits available) = bits available per semitone

(0.75 / 12) / (5 / 4096) = 51.2 bits available for tuning / semitone


With DAC Vref = 4V

1 bit = 4V / 4096 = 0.0009765625 V

(Voltage unit per octave / number of semitones) / ( DAC Voltage reference / DAC bits available) = bits available per semitone

(0.75 / 12) / (4 / 4096) = 64 bits available for tuning / semitone

LM337

Vout = Vin * (1 + R2/R1)
-1.25 * (1+510/120)

### DAC

Example 6-4: Bipolar Voltage Source With Selectable Gain and Offset

Vref = 5V

R1, R2, R3: 10k

Gain: DACa digital input
Offset: DACb digital input

Gain | Offset | Voltage |
-----|--------|---------|
0    | 0      |  0.0
0    | 500    |  0.57
0    | 1000   |  1.15
0    | 1500   |  1.72
0    | 2000   |  2.29
0    | 2500   |  2.86
0    | 3000   |  3.43
0    | 3500   |  4.01
0    | 4000   |  4.58
500  | 0      | -0.54
500  | 500    |  0.0
500  | 1000   |  0.58
500  | 1500   |  1.15
500  | 2000   |  1.72
500  | 2500   |  2.29
500  | 3000   |  2.87
500  | 3500   |  3.44
500  | 4000   |  4.02
1000 | 0      | -1.12
1000 | 500    | -0.54
1000 | 1000   |  0.0
1000 | 1500   |  0.58
1000 | 2000   |  1.15
1000 | 2500   |  1.72
1000 | 3000   |  2.29
1000 | 3500   |  2.87
1000 | 4000   |  3.44
1500 | 0      | -1.68
1500 | 500    | -1.11
1500 | 1000   | -0.54
1500 | 1500   |  0.0
1500 | 2000   |  0.58
1500 | 2500   |  1.15
1500 | 3000   |  1.72
1500 | 3500   |  2.30
1500 | 4000   |  2.88
2000 | 0      | -2.25
2000 | 500    | -1.69
2000 | 1000   | -1.11
2000 | 1500   | -0.54
2000 | 2000   |  0.0
2000 | 2500   |  0.58
2000 | 3000   |  1.15
2000 | 3500   |  1.73
2000 | 4000   |  2.30
2500 | 0      | -2.83
2500 | 500    | -2.26
2500 | 1000   | -1.68
2500 | 1500   | -1.11
2500 | 2000   | -0.54
2500 | 2500   |  0.0
2500 | 3000   |  0.57
2500 | 3500   |  1.15
2500 | 4000   |  1.72
3000 | 0      | -3.39
3000 | 500    | -2.82
3000 | 1000   | -2.25
3000 | 1500   | -1.68
3000 | 2000   | -1.11
3000 | 2500   | -0.54
3000 | 3000   |  0.0
3000 | 3500   |  0.58
3000 | 4000   |  1.15
3500 | 0      | -3.96
3500 | 500    | -3.93
3500 | 1000   | -2.82
3500 | 1500   | -2.25
3500 | 2000   | -1.68
3500 | 2500   | -1.11
3500 | 3000   | -0.54
3500 | 3500   |  0.0
3500 | 4000   |  0.58
4000 | 0      | -4.52
4000 | 500    | -3.96
4000 | 1000   | -3.38
4000 | 1500   | -2.82
4000 | 2000   | -2.25
4000 | 2500   | -1.68
4000 | 3000   | -1.11
4000 | 3500   | -0.54
4000 | 4000   |  0.0

## AS3394

// Voice:
// {
//   0..7000,   // Key CV
//   0..3500,   // Mod Amount
//   0..4000,   // Wave Select
//   0..2000,   // PWM
//   0..3500,   // Mixer Balance
//   0..2000,   // Resonance
//   0..6000,   // Cutoff
//   0..3500    // VCA
// }

## S&H

DAC settling time: 0.0000045s / 4.5 us / 4.5 * 1/1000000
16 000 000 Hz =>   0.0000000625 / tick

(4.5 * ( 1/1000000 )) / ( 1/16000000 ) => 72

```C
__builtin_avr_delay_cycles(72);
```

or

```C
 __asm__ __volatile__("nop");
```

"Every seven milliseconds it must advance each envelope, LFO and glide, and add the latest value into other control signals. ... The voices are controlled by 48 control voltages, which are generated by the DAC, demultiplexers, and sample/holds. Every voice has eight control voltage inputs, and they must all be updated every seven milliseconds."

=> (1000 / 7) * 8 = 1,142.8571428571 Hz for IRQ

## Connections

### DAC

```
MP4922 pin 1  +5V
MP4922 pin 2  NC
MP4922 pin 3  ~CS / Arduino pin 7
MP4922 pin 4  SCK / Arduino 13 - ICSP/SCK/3
MP4922 pin 5  SDI / Arduino 11 - ICSP/MOSI/4
MP4922 pin 6  NC
MP4922 pin 7  NC

MP4922 pin 8  ~LDAC / GND
MP4922 pin 9  ~SHDN / NC?
MP4922 pin 10 Voutb / 10k / Opamp Non-inverting input
MP4922 pin 11 Vrefb / +5V
MP4922 pin 12 GND
MP4922 pin 13 Vrefa / +5V
MP4922 pin 14 Vouta / 10k / Opamp Inverting input / 4051 pin 3
```

### Voice Select 4051

```
4051 pin 1  | out 4  | Voice Param 4 4051 pin 6
4051 pin 2  | out 6  | NC (Voice Param 6 4051 pin 6)
4051 pin 3  | COMMON | MP4922 pin 14
4051 pin 4  | out 7  | NC (Voice Param 7 4051 pin 6)
4051 pin 5  | out 5  | Voice Param 5 4051 pin 6
4051 pin 6  | INH    | Arduino pin 6 (Voice Select)
4051 pin 7  | Vee    | NC
4051 pin 8  | Vss    | GND

4051 pin 9  | C      | Arduino pin 10
4051 pin 10 | B      | Arduino pin 9
4051 pin 11 | A      | Arduino pin 8
4051 pin 12 | out 3  | Voice Param 3 4051 pin 6
4051 pin 13 | out 0  | Voice Param 0 4051 pin 6
4051 pin 14 | out 1  | Voice Param 1 4051 pin 6
4051 pin 15 | out 2  | Voice Param 2 4051 pin 6
4051 pin 16 | Vdd    | +5V
```

## Voice Param 0..7 4051

```
4051 pin 1  | out 4  | AS3394 pin 13 MIXER
4051 pin 2  | out 6  | AS3394 pin 20 CUTOFF
4051 pin 3  | COMMON | MP4922 pin 14
4051 pin 4  | out 7  | AS3394 pin 22 VCA
4051 pin 5  | out 5  | AS3394 pin 15 RESONANCE
4051 pin 6  | INH    | Voice Select 4051 pin 13/14/15/12/1/5/2/4
4051 pin 7  | Vee    | -6.5V
4051 pin 8  | Vss    | GND

4051 pin 9  | C      | Arduino pin 10
4051 pin 10 | B      | Arduino pin 9
4051 pin 11 | A      | Arduino pin 8
4051 pin 12 | out 3  | AS3394 pin 8 PWM
4051 pin 13 | out 0  | AS3394 pin 2 CV
4051 pin 14 | out 1  | AS3394 pin 6 MOD_AMT
4051 pin 15 | out 2  | AS3394 pin 7 WAVE_SELECT
4051 pin 16 | Vdd    | +5V
```
